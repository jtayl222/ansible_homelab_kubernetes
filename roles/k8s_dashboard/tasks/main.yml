- name: Download Helm install script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '0700'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Install Helm
  ansible.builtin.command: /tmp/get_helm.sh
  args:
    creates: /usr/local/bin/helm
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Ensure required variables are defined
  ansible.builtin.set_fact:
    node_ip: "{{ hostvars[groups['k3s_control_plane'][0]]['ansible_host'] | default(hostvars[inventory_hostname]['ansible_default_ipv4']['address'])
      }}"
    kubeconfig: "{{ kubeconfig | default(playbook_dir + '/fetched_tokens/k3s-kubeconfig')
      }}"

- name: Check if Kubernetes Dashboard is already installed
  ansible.builtin.command: helm list -n kubernetes-dashboard -q
  register: dashboard_installed
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  changed_when: false

- name: Uninstall existing Kubernetes Dashboard (if present)
  ansible.builtin.command: helm uninstall kubernetes-dashboard -n kubernetes-dashboard
  when: "'kubernetes-dashboard' in dashboard_installed.stdout"
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  changed_when: true  # This actually changes state by uninstalling

- name: Add Kubernetes Dashboard Helm repository
  ansible.builtin.command: helm repo add k8s-dashboard https://kubernetes.github.io/dashboard/
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  register: repo_add_result
  changed_when: "'has been added' in repo_add_result.stdout"
  failed_when:
    - repo_add_result.rc != 0
    - "'already exists' not in repo_add_result.stderr"

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  changed_when: true  # Helm repo update always refreshes state

- name: Install Kubernetes Dashboard using Helm
  ansible.builtin.command: >
    helm install kubernetes-dashboard k8s-dashboard/kubernetes-dashboard
    --namespace kubernetes-dashboard --create-namespace
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  register: install_result
  changed_when: install_result.rc == 0

- name: Create dashboard admin service account
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig }}'
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: dashboard-admin
        namespace: kubernetes-dashboard
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Create cluster role binding for dashboard admin
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig }}'
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: dashboard-admin-binding
      subjects:
        - kind: ServiceAccount
          name: dashboard-admin
          namespace: kubernetes-dashboard
      roleRef:
        kind: ClusterRole
        name: cluster-admin
        apiGroup: rbac.authorization.k8s.io
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Create long-lived token for dashboard admin
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig }}'
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: dashboard-admin-token
        namespace: kubernetes-dashboard
        annotations:
          kubernetes.io/service-account.name: dashboard-admin
      type: kubernetes.io/service-account-token
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Wait for token to be generated
  ansible.builtin.command: >
    kubectl --kubeconfig={{ kubeconfig }} -n kubernetes-dashboard
      get secret dashboard-admin-token
      -o jsonpath='{.data.token}'
  register: token_check
  until: token_check.stdout != ""
  retries: 10
  delay: 5
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  changed_when: false

- name: Create Ingress manifest for Kubernetes Dashboard
  ansible.builtin.template:
    src: dashboard-ingress.yml.j2
    dest: /tmp/dashboard-ingress.yml
    mode: '0600'  # Restricted permissions since it might contain sensitive info
  vars:
    dashboard_node_ip: "{{ hostvars[groups['k3s_control_plane'][0]]['ansible_host']
      | default('192.168.1.100') }}"
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false

- name: Apply Ingress for Kubernetes Dashboard
  ansible.builtin.command: kubectl apply -f /tmp/dashboard-ingress.yml
  environment:
    KUBECONFIG: '{{ kubeconfig }}'
  delegate_to: "{{ groups['ansible_controller'][0] }}"
  become: false
  register: apply_result
  changed_when: "'created' in apply_result.stdout or 'configured' in apply_result.stdout"
