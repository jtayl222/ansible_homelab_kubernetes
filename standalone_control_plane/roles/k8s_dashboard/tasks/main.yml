---
- name: Download Helm install script
  get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '0700'

- name: Install Helm
  command: /tmp/get_helm.sh
  args:
    creates: /usr/local/bin/helm

- name: Ensure required variables are defined
  set_fact:
    node_ip: "{{ ansible_default_ipv4.address }}"

- name: Check if Kubernetes Dashboard is already installed
  command: helm list -n kubernetes-dashboard -q
  register: dashboard_installed
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  ignore_errors: yes

- name: Uninstall existing Kubernetes Dashboard
  command: helm uninstall kubernetes-dashboard -n kubernetes-dashboard
  when: "'kubernetes-dashboard' in dashboard_installed.stdout"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Add Kubernetes Dashboard Helm repository
  command: helm repo add k8s-dashboard https://kubernetes.github.io/dashboard/
  ignore_errors: yes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Update Helm repositories
  command: helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Install Kubernetes Dashboard
  command: >
    helm install kubernetes-dashboard k8s-dashboard/kubernetes-dashboard
    --namespace kubernetes-dashboard
    --create-namespace
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create Ingress for Kubernetes Dashboard
  template:
    src: dashboard-ingress.yml.j2
    dest: /tmp/dashboard-ingress.yml
  vars:
    node_ip: "{{ node_ip }}"

- name: Apply Ingress for Kubernetes Dashboard
  command: kubectl apply -f /tmp/dashboard-ingress.yml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
